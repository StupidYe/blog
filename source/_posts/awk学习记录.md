---
title: awk学习记录
date: 2017-11-17 13:47:51
tags: [shell]
toc: true
---

#### awk的格式

awk指令由awk命令、括在引号（或写在文件）中的程序指令以及输入文件的文件名几个部分组成。

awk指令由模式、操作或模式与操作的组合组成。

<!-- more -->

- 从文件输入

  格式：

  ```shell
  awk 'pattern' filename
  awk '{action}' filename
  awk 'pattern {action}' filename
  ```

- 从命令输入

  可以将一条或多条linux命令的输出通过管道发给awk处理。

  格式：

  ```shell
  command | awk 'pattern'
  command | awk '{action}'
  command | awk 'pattern {action}'
  ```

#### awk 格式化输出

- print函数

  print函数用于打印不需要特别编排格式的简单输出。

  可以用`{print}`形式在awk命令的动作部分显示的调用print函数，print函数的参数可以是变量，述职或者字符串常量，字符串必须用双引号括起来。

  参数之间用**逗号**分隔，如果没有逗号，所有的参数就会被串在一起。

  逗号等价于OFS中的值，默认为空格。

  print函数输出可以被重定向，也可以通过管道传给另一个程序。

- OFMT变量

  用于打印数字时控制数字的格式。（也可以通过printf实现）

  OFMT的默认值是：**%.6gd**.表示只打印小数部分的前6位。

- printf函数

#### 文件中的awk命令

​	awk命令如果写在文件里，就要用-f选项指定awk文件名，后面再加上要处理的文件的文件名。

​	处理流程：

​	1.awk从缓冲区读入一条记录，接着测试awk文件中的每一条命令，然后对读入的记录执行命令。

​	2.处理完第一条记录后，awk将其丢弃，接着将下一条记录读入缓冲区，依次处理所有记录。

#### 记录和字段

##### 记录

​	在awk看来输入数据具有格式和结构，而不是无休止的字符串。默认情况下，每一行成称为一条记录，以换行符结束。

- 记录分隔符

  默认情况下，输入和输出记录的分隔符（行分隔符）都是回车符（换行符），分别保存在awk的内置变量**ORS** 和**RS** 中（可以修改，但是只能以特定方式修改）。

- 变量$0

  awk用$0指代整条记录。

- 变量NR

  每条记录的**记录号**都保存在awk的内置变量**NR**中。每处理完一条记录，NR的值都会加1. 

##### 字段

​	每条记录都是由字段词组成，默认情况下，字段间用**空白符（即空格或制表符）**分割。

​	每个这样的词称为一个字符，用awk内置变量**NF** 保存记录的字段数。

##### 字段分隔符

- 输入字段分隔符 

  awk的内置变量**FS** 中保存了输入字段分隔符的值。

  FS的默认值是空格或者制表符。

  可以通过在BEGIN语句或命令行上赋值来改变FS的值，在命令行上改变FS的值需要使用**-F** 选项。

- 使用多个字段分隔符

  如果有多个字符被用于字段分隔符，则FS对应的是一个正则表达式，并且被括在方括号[]中。**注意，一定要把多个分隔符的方括号用引号引起来，避免被shell解析** 。

  如：`awk -F'[ :\t]' '{print $1,$2,$3}'` 分隔符为空格，冒号和制表符

- 输出字段分隔符

  默认的输出字段分隔符是单个空格，被保存于awk的内置变量OFS中。

  无论OFS如何设置，print语句中用于分隔字段的逗号，在输出时都被转换成OFS的值。

#### 模式与操作

##### 模式

​	awk模式用来控制awk对输入的文本执行什么操作。

​	模式由正则表达式、判别条件真伪的表达式或者两者结合构成。

##### 操作

​	操作是花括号中以分号分隔的语句。

​	模式可以与操作结合使用。

​	操作如果紧跟在某个模式后面，它的第一个左花括号就必须与该模式同处一行。

​	模式永远不会出现在花括号中。

​	格式：

```
模式 { 操作语句; 操作语句; ...;}
或者
模式 {
	操作语句
	操作语句
	...
}
```

#### 正则表达式

awk中正则表示是被包在斜杠之间的。

awk的正则表达式元字符（列举不是很熟悉的）

1. &：用在替代串中，代表查找串中匹配到的内容

2. \\<>/：单词定位

3. \\(\\)：向前引用

4. 匹配操作符~：用于对记录或字段的表达式进行匹配

   比如：

   ```
   awk '$1 ~ /[Bb]ill/' file
   显示所有在第一个字符里匹配到Bill和bill的行。
   ```

#### 比较表达式

​	比较表达式用来对文本进行比较，只有条件为真，才执行指定的动作。

​	比较表达式使用关系运算符，用于比较数字与字符串。

##### 关系运算符

​	主要是`<` `<=` `==` ` !=` `>=` `>` `~` `!~`

​	`~`:与正则表达式匹配

​	`!~`与正则表达式不匹配

​	其他的与数学上的差不多。

##### 条件表达式

​	条件表达式用到两个符号`:`和`?` 

​	格式为：条件表达式1 ?  表达式2 : 表达式3

##### 算数运算

​	**awk按浮点方式执行算数运算** 。

​	主要有`+` `-` `*` `/` `%` `^` 

​	`^` ：幂运算

###### 逻辑运算符和复合模式

​	主要为逻辑与`&&`、逻辑或`||`、逻辑非`!`

##### 范围模式

​	范围模式先匹配从第一个模式的首次出现到第二个模式的首次出现之间的内容，然后匹配从第一个模式的下一次出现到第二个的下一次出现，依次类推。

​	如果匹配到第一个模式而没有发现第二个模式，awk就将显示从第一个模式首次出现的行到文件末尾之间的所有行。

​	比如 `awk '/Tom/,/Susan/' filename` 

#### 变量

##### 数值变量和字符串变量

- 初始化与强制类型转换

  只要在awk程序中被提到，变量就开始存在。变量类型取决于等号右边的那个表达式。

  如果要将一个字符串强制转换为数字，方法为：

  `string + 0`

  如果要将一个数字强制转换为字符串，方法为：

  `number  " "` 

##### 用户自定义变量

​	用户自定义变量的变量名可以由字母、数字和下划线组成，**但是不能以数字开头**。 

​	awk变量不用声明类型。

​	如果变量未被初始化，awk会将字符串变量初始化为空串，将数值变量初始化为0.

- awk的赋值运算符

  `=` ,`+=`,`-=`,`*=`,`/=`,`%=`,`^=`

- 递增和递减运算符

  `++` ,`--` 

- 字段变量

  字段变量可以像用户自定义的变量一样使用。

  新的字段可以通过赋值来创建。

  字符的值发生变化时，awk会以OFS的值作为字段分隔符重新计算$0的值。

  字段数目通常被限制在100以内。

- 内置变量

  内置变量的名字都是大写的。

  > 有点多，用到在查询吧

#### BEGIN模式

​	BEGIN模式后面跟一个操作卡。awk必须在对输入文件进行任何处理之前先执行该操作块。

​	BEGIN操作常常被用于修改内置变量（OFS、RS、FS等）的值，为用户自定义变量赋初值和打印输出的页眉或标题。

#### END模式

​	END模式不匹配任何输入行，而是执行任何与之关联的操作。

​	awk处理完所有输入行之后才处理END模式。

#### 重定向和管道

##### 输出重定向

​	**重定向的目标文件必须用双引号括起来** 

​	\> 文件被打开并清空

​	\>> 文件被打开，但不清空，向文件追加内容

##### 输入重定向

​	函数getline：用于读取下一输入行。（从标准输入、管道或文件(非当前处理的文件)）